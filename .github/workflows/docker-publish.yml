name: Build and push to docker and deploy EC2

on:
  push:
    branches: [ main ]
    paths:
      - '/Dockerfile'
      - '/docker-compose*.yml'
      - '.github/workflows/docker-publish.yml'

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  # build-and-push:
  #   runs-on: ubuntu-latest
    
  #   steps:
  #   - name: Checkout repository
  #     uses: actions/checkout@v3

  #   - name: Set up Docker Buildx
  #     uses: docker/setup-buildx-action@v2

  #   - name: Login to Docker Hub
  #     uses: docker/login-action@v2
  #     with:
  #       username: ${{ secrets.DOCKER_USERNAME }}
  #       password: ${{ secrets.DOCKER_TOKEN }}

  #   - name: Build and push producer
  #     uses: docker/build-push-action@v4
  #     with:
  #       context: .
  #       file: dockerfile.producer
  #       push: true
  #       tags: |
  #         ${{ env.DOCKER_USERNAME }}/scm-producer:${{ github.run_number }}
  #         ${{ env.DOCKER_USERNAME }}/scm-producer:latest

  #   - name: Build and push consumer
  #     uses: docker/build-push-action@v4
  #     with:
  #       context: .
  #       file: dockerfile.consumer
  #       push: true
  #       tags: |
  #         ${{ env.DOCKER_USERNAME }}/scm-consumer:${{ github.run_number }}
  #         ${{ env.DOCKER_USERNAME }}/scm-consumer:latest

  #   - name: Build and push backend
  #     uses: docker/build-push-action@v4
  #     with:
  #       context: .
  #       file: Dockerfile.application
  #       push: true
  #       tags: |
  #         ${{ env.DOCKER_USERNAME }}/scm-backend:${{ github.run_number }}
  #         ${{ env.DOCKER_USERNAME }}/scm-backend:latest

  deploy-ec2:
    # needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: check ssh
        run: |
          echo "Testing connectivity to ${{ secrets.SERVER_HOST }}:22"
          sudo apt-get update -y
          sudo apt-get install -y netcat-openbsd || true
          nc -vz ${{ secrets.SERVER_HOST }} 22 || true
      - name: Deploy to EC2 via SSH and docker-compose
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || '22' }}
          script: |
            set -e
            cd /opt/scmlite
            docker-compose pull
            docker-compose up -d --remove-orphans